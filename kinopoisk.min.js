/**
  * jQuery Kinopoisk Plugin 0.4
  *
  * Kinopoisk is a jQuery plugin that let you easily add to your web page movie rating informer. This informer shows
  * movie rating from kinopois.ru and imdb.com. It does not use any server side scripts. It use javascript and css files only.
  *
  * @name kinopoisk
  * @version 0.4
  * @requires jQuery v1.5.0+
  * @author Dmitry Shamin <dmitry.shamin@gmail.com>
  * @license Dual licensed under the MIT or GPL Version 2 licenses.
  *
  * Copyright 2012-2013, Dmitry Shamin
  */
(function(c){var b={movie:false,url:"http://rating.kinopoisk.ru",range:10,order:["kinopoisk","imdb"],kinopoisk_template:'<div><span class="kp_description">Рейтинг <a href="http://kinopoisk.ru" target="new">Кинопоиска</a>:</span><span class="kp_rating" title="Проголосовало $vote">$rating</span><span class="kp_stars">$stars</span></div>',imdb_template:'<div><span class="kp_description">Рейтинг <a href="http://imdb.com" target="new">IMDB</a>:</span><span class="kp_rating" title="Проголосовало $vote">$rating</span><span class="kp_stars">$stars</span></div>',cache_time:86400000};var a={init:function(d){return this.each(function(){var g=c(this);var h=c.extend({},b,g.data(),d);for(var f in h){if(f=="movie"){var e=h[f].toString().split("/");if(e.length>1){h[f]=e[4]}else{h[f]=e[0]}}}g.data({params:h});g.kinopoisk("getRating")})},getRating:function(){var d=c(this);var f=d.data("params");if(!f.movie){throw"Не указан идентификатор фильма на кинопоиске (data-movie)."}var e=a._getCache(d,f.movie);if(e){return a._showRating(d,e)}else{c.ajax({type:"GET",url:"http://query.yahooapis.com/v1/public/yql?q="+encodeURIComponent('select * from xml where url="'+f.url+"/"+f.movie+'.xml"')+"&format=xml&callback=?",dataType:"json",success:function(g){e=a._setCache(d,f.movie,g.results[0]);return a._showRating(d,e)},error:function(g){console.log(g);c.error(g.responseText)}})}},_getCache:function(g,d){var i=g.data("params");var h=new Date().getTime();var e=localStorage.getItem("movie_"+d);if(!e){return false}else{var j=c.parseXML(e);var f=c(j);if((h-f.find("cache_time").text())>i.cache_time){localStorage.removeItem("movie_"+d);return false}}return e},_setCache:function(f,h,k){var i=f.data("params");var l=new Date().getTime();var d=localStorage.getItem("movie_"+h);var j="<result>"+k+"<cache_time>"+l+"</cache_time></result>";if(!d){localStorage.setItem("movie_"+h,j)}else{var g=c.parseXML(d);var e=c(g);if((l-e.find("cache_time").text())>i.cache_time){localStorage.setItem("movie_"+h,j)}else{j=d}}return j},_showRating:function(e,k){var h=e.data("params");if(!k){throw'Проверьте правильность url "'+h.url+'"'}var g=c.parseXML(k);var d=c(g);var n=d.find("kp_rating");var l=d.find("imdb_rating");if(n.text()==0&&n.attr("num_vote")==0){return e.html('<span class="kp_container">Нет данных</span>')}n.stars=a._getStar(n.text(),h.range);l.stars=a._getStar(l.text(),h.range);var f={kinopoisk:a._getTemplate(h.kinopoisk_template,n),imdb:a._getTemplate(h.imdb_template,l)};var m="";for(var j in h.order){if(h.order.hasOwnProperty(j)){if(typeof f[h.order[j]]!="undefined"){m+=f[h.order[j]]}}}return e.hide().html('<span class="kp_container">'+m+"</span>").fadeIn()},_getTemplate:function(d,e){return d.replace("$rating",e.text()).replace("$vote",e.attr("num_vote")).replace("$stars",e.stars)},_getStar:function(f,d){var h="";var g=Math.round(f*d/10);for(var e=1;e<=d;e++){if(e<=g){h+="<span>&#9733;</span>"}else{h+="<span>&#9734;</span>"}}return h}};c.fn.kinopoisk=function(f){try{if(a[f]){if(f.charAt(0)=="_"){throw"Нельзя вызывать приватный метод"}return a[f].apply(this,Array.prototype.slice.call(arguments,1))}else{if(typeof f==="object"||!f){return a.init.apply(this,arguments)}else{throw"Метод "+f+" не найден"}}}catch(d){c.error(d)}}})(jQuery);$(document).ready(function(){$(".kinopoisk").kinopoisk()});
