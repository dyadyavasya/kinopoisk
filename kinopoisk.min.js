(function($){var methods={init:function(options){var settings={movie:false,url:"http://www.kinopoisk.ru/rating/",range:10,order:["kinopoisk","imdb"],kinopoisk_template:'<div><span class="kp_description">Рейтинг <a href="http://kinopoisk.ru" target="new">Кинопоиска</a>:</span><span class="kp_rating" title="Проголосовало $vote">$rating</span><span class="kp_stars">$stars</span></div>',imdb_template:'<div><span class="kp_description">Рейтинг <a href="http://imdb.com" target="new">IMDB</a>:</span><span class="kp_rating" title="Проголосовало $vote">$rating</span><span class="kp_stars">$stars</span></div>'};return this.each(function(){if(options){$.extend(settings,options)}var el=$(this);var data=el.data();for(var i in data){if(el.data(i)){settings[i]=el.data(i)}}el.kinopoisk("getRating",settings)})},getRating:function(settings){if(!settings.movie){throw"Не указан идентификатор фильма на кинопоиске (movie_id)."}var el=$(this);$.ajax({type:"GET",st:settings,url:"http://query.yahooapis.com/v1/public/yql?q="+encodeURIComponent('select * from xml where url="'+settings.url+"/"+settings.movie+'.xml"')+"&format=xml&callback=?",dataType:"json",beforeSend:function(jqXHR,settings){jqXHR.st=settings.st},success:function(data,testStatus,jqXHR){return el.kinopoisk("_showRating",data,jqXHR.st)},error:function(data){console.log(data);$.error(data.responseText)}})},_showRating:function(data,settings){var el=$(this);if(!data.results[0]){throw'Проверьте правильность url "'+settings.url+'"'}var xml_doc=$.parseXML(data.results[0]);var $xml=$(xml_doc);var $kp_rating=$xml.find("kp_rating");var $imdb_rating=$xml.find("imdb_rating");if($kp_rating.text()==0&&$kp_rating.attr("num_vote")==0){return el.html('<span class="kp_container">Нет данных</span>')}$kp_rating.stars=el.kinopoisk("_getStar",$kp_rating.text(),settings);$imdb_rating.stars=el.kinopoisk("_getStar",$imdb_rating.text(),settings);var ratings={kinopoisk:el.kinopoisk("_getTemplate",settings.kinopoisk_template,$kp_rating,settings),imdb:el.kinopoisk("_getTemplate",settings.imdb_template,$imdb_rating,settings)};var text="";for(var i in settings.order){text+=ratings[settings.order[i]]}return el.hide().html('<span class="kp_container">'+text+"</span>").fadeIn()},_getTemplate:function(template,$rating,settings){return template.replace("$rating",$rating.text()).replace("$vote",$rating.attr("num_vote")).replace("$stars",$rating.stars)},_getStar:function(rating,settings){var star="";var round_rating=Math.round(rating*settings.range/10);for(var i=1;i<=settings.range;i++){if(i<=round_rating){star+="<span>&#9733;</span>"}else{star+="<span>&#9734;</span>"}}return star}};$.fn.kinopoisk=function(method){try{if(methods[method]){return methods[method].apply(this,Array.prototype.slice.call(arguments,1))}else{if(typeof method==="object"||!method){return methods.init.apply(this,arguments)}else{throw"Метод "+method+" не найден"}}}catch(e){$.error(e)}}})(jQuery);$(document).ready(function(){$(".kinopoisk").kinopoisk()});